<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Ultimate NC Political Realignment Map (2008-2024)</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>
    <meta property="og:title" content="NC Political Realignment Map (2008-2024)">
    <meta property="og:description" content="Interactive visualization of North Carolina's political trends from 2008 to 2024, showing county-level and precinct-level voting patterns.">
    <meta property="og:image" content="preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet'>
    <link href='styles/common.css' rel='stylesheet'>
    <script src='scripts/common.js'></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            left: 0;
            right: 400px; /* Leave space for sidebar */
            transition: right 0.3s ease;
        }
        
        #map.sidebar-minimized {
            right: 0px; /* Minimized sidebar width */
        }
        
        /* Main Controls */
        .main-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            min-width: 380px;
            max-width: 420px;
            transition: all 0.3s ease;
        }
        
        .main-controls.minimized {
            min-width: 60px;
            max-width: 60px;
            padding: 15px;
        }
        
        .main-controls.minimized .controls-content {
            display: none;
        }
        
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .minimize-btn {
            background: #e5e7eb;
            border: none;
            border-radius: 6px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .minimize-btn:hover {
            background: #d1d5db;
        }
        
        .floating-expand-btn {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: background-color 0.2s;
            display: none;
        }
        
        .floating-expand-btn:hover {
            background: #f3f4f6;
        }
        
        .sidebar.minimized + .floating-expand-btn {
            display: flex;
        }
        
        .main-controls h3 {
            margin: 0;
            color: #1f2937;
            font-weight: 600;
            font-size: 16px;
        }
        
        .main-controls select, .main-controls button {
            width: 100%;
            margin-bottom: 10px;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: #ffffff;
            border-left: 1px solid #e5e7eb;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sidebar.minimized {
            transform: translateX(100%) !important;
            visibility: hidden !important;
        }
        
        /* Ensure no gray background when sidebar is minimized */
        body.sidebar-minimized {
            overflow-x: hidden !important;
        }
        
        /* Force map to extend fully when sidebar minimized */
        body.sidebar-minimized #map {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 0 !important;
        }
        
        .sidebar.minimized .sidebar-content {
            display: none;
        }
        
        .sidebar.minimized .sidebar-header h3 {
            display: none;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar.minimized .sidebar-header {
            padding: 10px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: none;
            border-radius: 8px 0 0 8px;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
        }
        
        .sidebar-content {
            padding: 20px;
        }
        
        /* County Details */
        .county-details {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .county-details h4 {
            margin: 0 0 15px 0;
            color: #1e293b;
            font-size: 16px;
            font-weight: 600;
        }
        
        .county-details .result-summary,
        .county-details .winner-section,
        .county-details .margin-section,
        .county-details .vote-breakdown,
        .county-details .competitiveness-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .county-details .result-summary:last-child,
        .county-details .winner-section:last-child,
        .county-details .margin-section:last-child,
        .county-details .vote-breakdown:last-child,
        .county-details .competitiveness-section:last-child {
            border-bottom: none;
        }
        
        .county-details h5 {
            margin: 0 0 8px 0;
            color: #374151;
            font-size: 14px;
            font-weight: 600;
        }
        
        .county-details p {
            margin: 4px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* Statewide Results */
        .statewide-results {
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
            margin-bottom: 20px;
        }
        
        .statewide-results h4 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }
        
        .statewide-margin {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }
        
        .margin-text {
            font-weight: 600;
            font-size: 16px;
        }
        
        .margin-details {
            font-size: 13px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Research Findings */
        .findings-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }
        
        .findings-section h4 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }
        
        .finding-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .finding-card h5 {
            margin: 0 0 12px 0;
            color: #1f2937;
            font-size: 15px;
            font-weight: 600;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 6px;
        }
        
        .finding-card p {
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.5;
            color: #374151;
        }
        
        .finding-card .metric {
            background: #eff6ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #1d4ed8;
            display: inline-block;
            margin: 2px;
        }
        
        .swing-arrow {
            width: 20px;
            height: 20px;
            position: absolute;
            z-index: 1001;
            pointer-events: none;
            transition: all 0.3s ease;
            filter: drop-shadow(0px 0px 3px rgba(0, 0, 0, 0.5));
            clip-path: polygon(0% 20%, 60% 20%, 60% 0%, 100% 50%, 60% 100%, 60% 80%, 0% 80%);
            transform-origin: center center;
        }
        
        .swing-arrow.republican {
            background-color: rgba(255, 0, 0, 0.9);
        }
        
        .swing-arrow.democratic {
            background-color: rgba(0, 0, 255, 0.9);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 500;
            font-size: 14px;
        }
        
        select, button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }
        
        select:focus, button:focus {
            outline: none;
            border-color: #3498db;
        }
        
        button {
            cursor: pointer;
            margin: 3px 0;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f4e79);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }
        
        .analysis-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .mode-toggle {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 500;
        }
        
        .mode-toggle.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            max-height: 450px;
            overflow-y: auto;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        .legend.minimized {
            padding: 10px;
            min-width: 120px;
        }
        
        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .legend.minimized .legend-content {
            display: none;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            font-size: 12px;
            color: #34495e;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .status-panel {
            position: absolute;
            top: 20px;
            right: 240px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            max-width: 300px;
            font-size: 13px;
            color: #34495e;
        }
        
        .county-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            max-width: 400px;
            font-size: 13px;
            display: none;
        }

        /* Search Bar */
        #county-search {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="share-container" style="position: fixed; top: 20px; right: 440px; z-index: 1000;"></div>
    <div id="map"></div>
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
    <div id="progress" class="progress-bar">
        <div class="fill"></div>
    </div>
    
    <div class="main-controls" id="main-controls">
        <div class="controls-header">
            <h3>🗳️ NC Political Categories</h3>
            <button class="minimize-btn" onclick="toggleMainControls()" id="controls-minimize-btn">−</button>
        </div>
        <div class="controls-content" id="controls-content">
            <div class="analysis-mode">
                <div class="mode-toggle active" id="county-mode" onclick="setMode('county')">County Results</div>
                <div class="mode-toggle" id="precinct-mode" onclick="setMode('precinct')">Precinct Patterns</div>
            </div>
        
        <div class="control-group">
            <label>📊 Contest Type:</label>
            <select id="contest" onchange="applyCategories()">
                <option value="">Select a Contest...</option>
                <option value="presidential_2008_1">US President (2008)</option>
                <option value="presidential_2012_1">US President (2012)</option>
                <option value="presidential_2016_1">US President (2016)</option>
                <option value="presidential_2020_1">US President (2020)</option>
                <option value="presidential_2024_1">US President (2024)</option>
                <option value="us_senate_2008_1">US Senate (2008) - Kay Hagan vs Elizabeth Dole</option>
                <option value="us_senate_2010_1">US Senate (2010) - Elaine Marshall vs Richard Burr</option>
                <option value="us_senate_2014_1">US Senate (2014) - Kay Hagan vs Thom Tillis</option>
                <option value="us_senate_2016_1">US Senate (2016) - Deborah Ross vs Richard Burr</option>
                <option value="us_senate_2020_1">US Senate (2020) - Cal Cunningham vs Thom Tillis</option>
                <option value="us_senate_2022_1">US Senate (2022) - Cheri Beasley vs Ted Budd</option>
                <option value="governor_2008_1">NC Governor (2008)</option>
                <option value="governor_2012_1">NC Governor (2012)</option>
                <option value="governor_2016_1">NC Governor (2016)</option>
                <option value="governor_2020_1">NC Governor (2020)</option>
                <option value="governor_2024_1">NC Governor (2024)</option>
                <option value="attorney_general_2008_1">NC Attorney General (2008)</option>
                <option value="attorney_general_2016_1">NC Attorney General (2016)</option>
                <option value="attorney_general_2020_1">NC Attorney General (2020)</option>
                <option value="attorney_general_2024_1">NC Attorney General (2024)</option>
                <option value="lt_governor_2008_1">NC Lieutenant Governor (2008)</option>
                <option value="lt_governor_2012_1">NC Lieutenant Governor (2012)</option>
                <option value="lt_governor_2016_1">NC Lieutenant Governor (2016)</option>
                <option value="lt_governor_2020_1">NC Lieutenant Governor (2020)</option>
                <option value="lt_governor_2024_1">NC Lieutenant Governor (2024)</option>
                <option value="treasurer_2020_1">NC Treasurer (2020)</option>
                <option value="treasurer_2024_1">NC Treasurer (2024)</option>
                <option value="commissioner_agriculture_2008_1">Agriculture Commissioner (2008)</option>
                <option value="commissioner_agriculture_2012_1">Agriculture Commissioner (2012)</option>
                <option value="commissioner_agriculture_2016_1">Agriculture Commissioner (2016)</option>
                <option value="commissioner_agriculture_2020_1">Agriculture Commissioner (2020)</option>
                <option value="commissioner_agriculture_2024_1">Agriculture Commissioner (2024)</option>
                <option value="commissioner_insurance_2008_1">Insurance Commissioner (2008)</option>
                <option value="commissioner_insurance_2012_1">Insurance Commissioner (2012)</option>
                <option value="commissioner_insurance_2016_1">Insurance Commissioner (2016)</option>
                <option value="commissioner_insurance_2020_1">Insurance Commissioner (2020)</option>
                <option value="commissioner_insurance_2024_1">Insurance Commissioner (2024)</option>
                <option value="commissioner_labor_2008_1">Labor Commissioner (2008)</option>
                <option value="commissioner_labor_2012_1">Labor Commissioner (2012)</option>
                <option value="commissioner_labor_2016_1">Labor Commissioner (2016)</option>
                <option value="commissioner_labor_2020_1">Labor Commissioner (2020)</option>
                <option value="commissioner_labor_2024_1">Labor Commissioner (2024)</option>
                <option value="secretary_of_state_2008_1">Secretary of State (2008)</option>
                <option value="secretary_of_state_2012_1">Secretary of State (2012)</option>
                <option value="secretary_of_state_2016_1">Secretary of State (2016)</option>
                <option value="secretary_of_state_2020_1">Secretary of State (2020)</option>
                <option value="secretary_of_state_2024_1">Secretary of State (2024)</option>
                <option value="superintendent_instruction_2008_1">Superintendent of Instruction (2008)</option>
                <option value="superintendent_instruction_2012_1">Superintendent of Instruction (2012)</option>
                <option value="superintendent_instruction_2016_1">Superintendent of Instruction (2016)</option>
                <option value="superintendent_instruction_2020_1">Superintendent of Instruction (2020)</option>
                <option value="superintendent_instruction_2024_1">Superintendent of Instruction (2024)</option>
                <option value="state_auditor_2008_1">State Auditor (2008)</option>
                <option value="state_auditor_2012_1">State Auditor (2012)</option>
                <option value="state_auditor_2016_1">State Auditor (2016)</option>
                <option value="state_auditor_2020_1">State Auditor (2020)</option>
                <option value="state_auditor_2024_1">State Auditor (2024)</option>
            </select>
        </div>
        
        <button onclick="applyCategories()" class="btn-primary">
            🎨 Apply Political Categories
        </button>
        
        <button onclick="resetView()" class="btn-secondary">
            🔄 Reset View
        </button>
        
        <button onclick="toggleLabels()" class="btn-success">
            🏷️ Toggle County Labels
        </button>
        
        <button onclick="togglePrecinctsLayer()" class="btn-warning">
            📍 Toggle Precincts
        </button>
        
        <div class="control-group" style="margin-top: 15px;">
            <label>🔍 Quick Analysis:</label>
            <button onclick="showSwingCounties()" class="btn-secondary" style="font-size: 12px;">
                Find Swing Counties
            </button>
        </div>

        <div class="control-group">
            <label>🔄 Compare to Previous:</label>
            <select id="compare-election" onchange="showSwingArrows()">
                <option value="">Select comparison election...</option>
                <option value="presidential_2008_1">US President (2008)</option>
                <option value="presidential_2012_1">US President (2012)</option>
                <option value="presidential_2016_1">US President (2016)</option>
                <option value="presidential_2020_1">US President (2020)</option>
                <option value="us_senate_2008_1">US Senate (2008)</option>
                <option value="us_senate_2010_1">US Senate (2010)</option>
                <option value="us_senate_2014_1">US Senate (2014)</option>
                <option value="us_senate_2016_1">US Senate (2016)</option>
                <option value="us_senate_2020_1">US Senate (2020)</option>
                <option value="us_senate_2022_1">US Senate (2022)</option>
            </select>
            <button onclick="hideSwingArrows()" class="btn-secondary">
                Clear Swing Arrows
            </button>
        </div>
        </div> <!-- End controls-content -->
    </div>
    
    <!-- Sidebar for County Details and Research Findings -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>📊 County Analysis</h3>
            <button class="minimize-btn" onclick="toggleSidebar()" id="sidebar-minimize-btn">−</button>
        </div>
        <div class="sidebar-content">
            <!-- County Details Sidebar: moved above statewide margin -->
            <div class="county-details" id="county-details" style="display: none;">
              <h4 id="county-name">Select a County</h4>
              <div id="county-info-content">
                Click on any county to see detailed election results and competitiveness analysis.
              </div>
            </div>
            <div style="margin-bottom: 16px;">
                <label for="county-search" style="font-weight:600;">Search County:</label>
                <input type="text" id="county-search" placeholder="Type to search..." style="width:100%;padding:8px;border-radius:6px;margin-top:6px;margin-bottom:6px;" />
            </div>
            <div class="statewide-results" id="statewide-results">
                <h4>🏛️ North Carolina Statewide</h4>
                <div id="statewide-content">
                    <p>Select a contest to see statewide results and margin.</p>
                </div>
            </div>
            <!-- Research Findings -->
            <div class="findings-section">
                <h4>🔍 Research Findings</h4>
                
                <div class="finding-card">
                    <h5>Cabarrus County - Suburban Shift</h5>
                    <p><strong>Competitive Trend:</strong> While still leaning Republican, Cabarrus has become significantly more competitive. <span class="metric">2020: R+9.4%</span> → <span class="metric">2024: R+7.7%</span></p>
                    <p><strong>2020 Breakthrough:</strong> Trump 53.94% vs Biden 44.50% - first time since 2008 a Democrat cracked 40%</p>
                    <p><strong>2024 Continuation:</strong> Trump 53.03% vs Harris 45.34%, maintaining the competitive trend</p>
                    <p><strong>Demographics:</strong> Unaffiliated registration now surpasses both major parties. Fast-growing communities: Concord, Kannapolis, Harrisburg</p>
                    <p><strong>Geography:</strong> Charlotte metro spillover driving suburban growth and political transformation</p>
                </div>
                
                <div class="finding-card">
                    <h5>Alamance County - Statistical Consistency</h5>
                    <p><strong>Competitive Trend:</strong> Steady competitiveness with remarkably consistent Democratic performance. <span class="metric">2020: R+8.4%</span> → <span class="metric">2024: R+8.1%</span></p>
                    <p><strong>2020 Results:</strong> Trump 53.50% vs Biden 45.10% - first time since 2008 a Democrat reached 45% (Obama got 44.94%)</p>
                    <p><strong>2024 Consistency:</strong> Trump 53.36% vs Harris 45.22% - nearly identical Democratic share (45.10% vs 45.22%)</p>
                    <p><strong>Growth Centers:</strong> Graham, Burlington, and especially Mebane (I-40/I-85 corridor). Buc-ee's opening late 2026/early 2027 signals commercial growth</p>
                    <p><strong>Key Insight:</strong> Statistical similarity across cycles highlights persistent competitive trends in this swing county</p>
                </div>
                
                <div class="finding-card">
                    <h5>Regional Transformation</h5>
                    <p><strong>Suburban Realignment:</strong> Both counties exemplify the transformation of formerly safe Republican areas into competitive battlegrounds</p>
                    <p><strong>Unaffiliated Surge:</strong> In both counties, unaffiliated voters now outnumber Democrats and Republicans, creating volatile electoral dynamics</p>
                    <p><strong>Geographic Advantage:</strong> Proximity to Charlotte, the Triad, and Triangle drives population growth and political moderation</p>
                    <p><strong>Turnout Impact:</strong> Rising voter registration and turnout make these counties pivotal to statewide margins</p>
                    <p><strong>National Pattern:</strong> These trends mirror broader suburban realignment across the United States</p>
                </div>
            </div>
            
            <!-- Ensure county details sidebar elements exist and are correctly placed inside sidebar-content -->
            <div class="county-details" id="county-details" style="display: none;">
              <h4 id="county-name">Select a County</h4>
              <div id="county-info-content">
                Click on any county to see detailed election results and competitiveness analysis.
              </div>
            </div>
        </div>
    </div>
    
    <!-- Floating expand button (shown when sidebar is minimized) -->
    <button class="floating-expand-btn" onclick="toggleSidebar()" id="floating-expand-btn">+</button>
    
    <div class="status-panel" id="status" style="display:none;">
      <button id="status-exit" title="Close" style="position:absolute;top:10px;right:10px;padding:4px 10px;border-radius:6px;border:none;background:#eee;cursor:pointer;font-weight:bold;font-size:18px;">×</button>
      <strong>Status:</strong> Loading map and data...
    </div>
    
    <div class="legend" id="legend">
        <div class="legend-header">
            <h4>Political Categories</h4>
            <button class="minimize-btn" onclick="toggleLegend()" id="legend-minimize-btn">−</button>
        </div>
        <div class="legend-content" id="legend-content">
        <div class="legend-item"><div class="legend-color" style="background: #67000d;"></div>Annihilation Rep (40%+)</div>
        <div class="legend-item"><div class="legend-color" style="background: #a50f15;"></div>Dominant Rep (30-40%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #cb181d;"></div>Stronghold Rep (20-30%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #ef3b2c;"></div>Safe Rep (10-20%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #fb6a4a;"></div>Likely Rep (5.5-10%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #fcae91;"></div>Lean Rep (1-5.5%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #fee8c8;"></div>Tilt Rep (0.5-1%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #f7f7f7; border: 1px solid #999;"></div>Tossup (±0.5%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #e1f5fe;"></div>Tilt Dem (0.5-1%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #c6dbef;"></div>Lean Dem (1-5.5%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #9ecae1;"></div>Likely Dem (5.5-10%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #6baed6;"></div>Safe Dem (10-20%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #3182bd;"></div>Stronghold Dem (20-30%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #08519c;"></div>Dominant Dem (30-40%)</div>
        <div class="legend-item"><div class="legend-color" style="background: #08306b;"></div>Annihilation Dem (40%+)</div>
        </div>
    </div>

    <script>
       mapboxgl.accessToken = 'pk.eyJ1Ijoic2hhbWFyZGF2aXMiLCJhIjoiY21kcW8yeDB2MDhvbTJzb29qeGp1aDZmZCJ9.Zw_i6U-dL7_bEKRHTUh7yg'
        
        let loadingManager, analyticsManager;

        // Initialize managers and UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadingManager = new LoadingManager();
            analyticsManager = new AnalyticsManager();
            MobileWarning.show();

            // Initialize social sharing
            const shareContainer = document.getElementById('share-container');
            SocialShare.createButtons(shareContainer, window.location.href, document.title);
        });

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-79.0, 35.5],
            zoom: 6.5
        });
        
        let electionData = null;
        let currentMode = 'county';
        let countiesLoaded = false;
        let precinctsLoaded = false;
        let currentElectionResults = null;
        let lastSelectedCounty = null;
        
        function updateStatus(message) {
            // If message contains [object HTMLSelectElement], replace with a more user-friendly text
            if (typeof message === 'string' && message.includes('[object HTMLSelectElement]')) {
                message = message.replace('[object HTMLSelectElement]', 'Contest');
            }
            document.getElementById('status').innerHTML = `<strong>Status:</strong> ${message}`;
            console.log(message);
        }
        
        // Toggle main controls minimize/expand
        function toggleMainControls() {
            const controls = document.getElementById('main-controls');
            const btn = document.getElementById('controls-minimize-btn');
            
            if (controls.classList.contains('minimized')) {
                controls.classList.remove('minimized');
                btn.textContent = '−';
            } else {
                controls.classList.add('minimized');
                btn.textContent = '+';
            }
        }
        
        // Toggle sidebar minimize/expand
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const btn = document.getElementById('sidebar-minimize-btn');
            const floatingBtn = document.getElementById('floating-expand-btn');
            const mapElement = document.getElementById('map');
            const body = document.body;
            
            if (sidebar.classList.contains('minimized')) {
                sidebar.classList.remove('minimized');
                mapElement.classList.remove('sidebar-minimized');
                body.classList.remove('sidebar-minimized');
                btn.textContent = '−';
                floatingBtn.style.display = 'none';
                // Force map resize after sidebar shows
                setTimeout(() => map.resize(), 300);
            } else {
                sidebar.classList.add('minimized');
                mapElement.classList.add('sidebar-minimized');
                body.classList.add('sidebar-minimized');
                btn.textContent = '+';
                floatingBtn.style.display = 'flex';
                // Force map resize after sidebar hides
                setTimeout(() => map.resize(), 300);
            }
        }
        
        // Toggle legend minimize/expand
        function toggleLegend() {
            const legend = document.getElementById('legend');
            const btn = document.getElementById('legend-minimize-btn');
            
            if (legend.classList.contains('minimized')) {
                legend.classList.remove('minimized');
                btn.textContent = '−';
            } else {
                legend.classList.add('minimized');
                btn.textContent = '+';
            }
        }
        
        // Calculate and display statewide results
        function updateStatewideResults(results, contest, year) {
            let demTotal = 0, repTotal = 0, totalVotes = 0;
            
            Object.values(results).forEach(result => {
                if (result.dem_votes && result.rep_votes) {
                    demTotal += result.dem_votes;
                    repTotal += result.rep_votes;
                    totalVotes += result.dem_votes + result.rep_votes;
                }
            });
            
            if (totalVotes === 0) {
                document.getElementById('statewide-content').innerHTML = 
                    '<p>No statewide data available for this contest.</p>';
                return;
            }
            
            const demPercent = (demTotal / totalVotes * 100);
            const repPercent = (repTotal / totalVotes * 100);
            const margin = Math.abs(demPercent - repPercent);
            const winner = demPercent > repPercent ? 'Democratic' : 'Republican';
            const winnerPercent = Math.max(demPercent, repPercent);
            const loserPercent = Math.min(demPercent, repPercent);
            
            // Determine category based on margin
            let category;
            if (margin >= 40) {
                category = `Annihilation ${winner}`;
            } else if (margin >= 30) {
                category = `Dominant ${winner}`;
            } else if (margin >= 20) {
                category = `Stronghold ${winner}`;
            } else if (margin >= 10) {
                category = `Safe ${winner}`;
            } else if (margin >= 5.5) {
                category = `Likely ${winner}`;
            } else if (margin >= 1) {
                category = `Lean ${winner}`;
            } else if (margin >= 0.5) {
                category = `Tilt ${winner}`;
            } else {
                category = 'Tossup';
            }
            
            const marginText = `${winner} +${margin.toFixed(1)}%`;
            
            document.getElementById('statewide-content').innerHTML = `
                <div class="statewide-margin">
                    <div class="margin-text" style="color: ${winner === 'Democratic' ? '#1e40af' : '#dc2626'}">${marginText}</div>
                    <div class="margin-details">
                        ${winnerPercent.toFixed(1)}% vs ${loserPercent.toFixed(1)}% • ${category}
                    </div>
                    <div class="margin-details">
                        ${demTotal.toLocaleString()} D, ${repTotal.toLocaleString()} R • ${totalVotes.toLocaleString()} total votes
                    </div>
                </div>
            `;
        }
        
        function setMode(mode) {
            console.log(`Setting mode to: ${mode}`);
            currentMode = mode;
            document.getElementById('county-mode').classList.toggle('active', mode === 'county');
            document.getElementById('precinct-mode').classList.toggle('active', mode === 'precinct');
            analyticsManager.trackEvent('visualization', 'change_mode', mode);
            
            if (mode === 'county') {
                updateStatus(`Switched to County Results mode - shows actual county winners`);
            } else {
                updateStatus(`Switched to Precinct Patterns mode - shows dominant precinct categories`);
            }
            
            // Automatically reapply current selection if data is loaded
            if (currentElectionResults) {
                console.log('Reapplying categories after mode change');
                const contest = document.getElementById('contest').value;
                console.log(`Current contest: ${contest}`);
                applyCategories();
            } else {
                console.log('No election results loaded yet');
            }
        }
        
        // County name mapping for election data
        const countyNameMap = {
            'ALAMANCE': 'Alamance', 'ALEXANDER': 'Alexander', 'ALLEGHANY': 'Alleghany',
            'ANSON': 'Anson', 'ASHE': 'Ashe', 'AVERY': 'Avery', 'BEAUFORT': 'Beaufort',
            'BERTIE': 'Bertie', 'BLADEN': 'Bladen', 'BRUNSWICK': 'Brunswick',
            'BUNCOMBE': 'Buncombe', 'BURKE': 'Burke', 'CABARRUS': 'Cabarrus',
            'CALDWELL': 'Caldwell', 'CAMDEN': 'Camden', 'CARTERET': 'Carteret',
            'CASWELL': 'Caswell', 'CATAWBA': 'Catawba', 'CHATHAM': 'Chatham',
            'CHEROKEE': 'Cherokee', 'CHOWAN': 'Chowan', 'CLAY': 'Clay',
            'CLEVELAND': 'Cleveland', 'COLUMBUS': 'Columbus', 'CRAVEN': 'Craven',
            'CUMBERLAND': 'Cumberland', 'CURRITUCK': 'Currituck', 'DARE': 'Dare',
            'DAVIDSON': 'Davidson', 'DAVIE': 'Davie', 'DUPLIN': 'Duplin',
            'DURHAM': 'Durham', 'EDGECOMBE': 'Edgecombe', 'FORSYTH': 'Forsyth',
            'FRANKLIN': 'Franklin', 'GASTON': 'Gaston', 'GATES': 'Gates',
            'GRAHAM': 'Graham', 'GRANVILLE': 'Granville', 'GREENE': 'Greene',
            'GUILFORD': 'Guilford', 'HALIFAX': 'Halifax', 'HARNETT': 'Harnett',
            'HAYWOOD': 'Haywood', 'HENDERSON': 'Henderson', 'HERTFORD': 'Hertford',
            'HOKE': 'Hoke', 'HYDE': 'Hyde', 'IREDELL': 'Iredell', 'JACKSON': 'Jackson',
            'JOHNSTON': 'Johnston', 'JONES': 'Jones', 'LEE': 'Lee', 'LENOIR': 'Lenoir',
            'LINCOLN': 'Lincoln', 'MCDOWELL': 'McDowell', 'MACON': 'Macon',
            'MADISON': 'Madison', 'MARTIN': 'Martin', 'MECKLENBURG': 'Mecklenburg',
            'MITCHELL': 'Mitchell', 'MONTGOMERY': 'Montgomery', 'MOORE': 'Moore',
            'NASH': 'Nash', 'NEW HANOVER': 'New Hanover', 'NORTHAMPTON': 'Northampton',
            'ONSLOW': 'Onslow', 'ORANGE': 'Orange', 'PAMLICO': 'Pamlico',
            'PASQUOTANK': 'Pasquotank', 'PENDER': 'Pender', 'PERQUIMANS': 'Perquimans',
            'PERSON': 'Person', 'PITT': 'Pitt', 'POLK': 'Polk', 'RANDOLPH': 'Randolph',
            'RICHMOND': 'Richmond', 'ROBESON': 'Robeson', 'ROCKINGHAM': 'Rockingham',
            'ROWAN': 'Rowan', 'RUTHERFORD': 'Rutherford', 'SAMPSON': 'Sampson',
            'SCOTLAND': 'Scotland', 'STANLY': 'Stanly', 'STOKES': 'Stokes',
            'SURRY': 'Surry', 'SWAIN': 'Swain', 'TRANSYLVANIA': 'Transylvania',
            'TYRRELL': 'Tyrrell', 'UNION': 'Union', 'VANCE': 'Vance', 'WAKE': 'Wake',
            'WARREN': 'Warren', 'WASHINGTON': 'Washington', 'WATAUGA': 'Watauga',
            'WAYNE': 'Wayne', 'WILKES': 'Wilkes', 'WILSON': 'Wilson',
            'YADKIN': 'Yadkin', 'YANCEY': 'Yancey'
        };
        
        map.on('load', async () => {
            updateStatus('Loading counties and election data...');
            loadingManager.startTask();
            loadingManager.setProgress(0);
            
            try {
                // Load real county boundaries
                const countyResponse = await fetch('./data/nc_counties.geojson');
                const counties = await countyResponse.json();
                
                map.addSource('counties', {
                    type: 'geojson',
                    data: counties
                });
                
                // County fill layer
                map.addLayer({
                    id: 'county-fill',
                    type: 'fill',
                    source: 'counties',
                    paint: {
                        'fill-color': '#e0e0e0',
                        'fill-opacity': 0.7
                    }
                });
                
                // County outline layer
                map.addLayer({
                    id: 'county-outline',
                    type: 'line',
                    source: 'counties',
                    paint: {
                        'line-color': '#333',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                
                // County labels layer
                map.addLayer({
                    id: 'county-labels',
                    type: 'symbol',
                    source: 'counties',
                    layout: {
                        'text-field': ['get', 'County'],
                        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                        'text-size': 11,
                        'text-anchor': 'center',
                        'text-allow-overlap': false,
                        'text-ignore-placement': false
                    },
                    paint: {
                        'text-color': '#000000',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 2
                    }
                });
                
                countiesLoaded = true;
                loadingManager.setProgress(40);
                
                // Load precincts (initially hidden)
                try {
                    const precinctResponse = await fetch('./data/nc_precincts_enhanced_2024.geojson');
                    const precincts = await precinctResponse.json();
                    
                    map.addSource('precincts', {
                        type: 'geojson',
                        data: precincts
                    });
                    
                    map.addLayer({
                        id: 'precinct-fill',
                        type: 'fill',
                        source: 'precincts',
                        paint: {
                            'fill-color': '#e0e0e0',
                            'fill-opacity': 0.5
                        },
                        layout: {
                            'visibility': 'none'
                        }
                    });
                    
                    map.addLayer({
                        id: 'precinct-outline',
                        type: 'line',
                        source: 'precincts',
                        paint: {
                            'line-color': '#666',
                            'line-width': 0.5,
                            'line-opacity': 0.6
                        },
                        layout: {
                            'visibility': 'none'
                        }
                    });
                    
                    precinctsLoaded = true;
                loadingManager.setProgress(60);
                } catch (e) {
                    console.log('Precincts not available:', e);
                }
                
                // Fit to North Carolina
                map.fitBounds([[-84.5, 33.8], [-75.5, 36.6]], { padding: 50 });
                
                // Load comprehensive election data
                const electionResponse = await fetch('./data/nc_statewide_precinct_comprehensive_2008_2024_UPDATED_MERGED.json');
                electionData = await electionResponse.json();
                loadingManager.setProgress(100);
                
                // updateStatus removed to hide contest count window
                loadingManager.completeTask();
                
                // Track successful load
                analyticsManager.trackEvent('map', 'load', 'success');
            } catch (error) {
                updateStatus(`❌ Error loading data: ${error.message}`);
                console.error(error);
                loadingManager.hide();
                analyticsManager.trackEvent('error', 'map_load_failed', error.message);
            }
        });
        
        function applyCategories() {
            if (!electionData || !countiesLoaded) {
                updateStatus('❌ Data not ready yet!');
                return;
            }
            
            loadingManager.startTask();
            
            const contestElement = document.getElementById('contest');
            
            if (!contestElement) {
                updateStatus('❌ Contest dropdown not found!');
                return;
            }
            
            const contest = contestElement.value;
            
            if (!contest) {
                updateStatus('❌ Please select a contest!');
                return;
            }
            
            // Extract year from contest (e.g., "presidential_2024_1" -> "2024")
            const yearMatch = contest.match(/_(\d{4})_/);
            if (!yearMatch) {
                updateStatus('❌ Could not determine year from contest selection!');
                return;
            }
            const year = yearMatch[1];
            
            updateStatus(`🔍 Loading ${year} precinct and county data...`);
            
            // Extract contest type from the dropdown value and handle different contest formats
            const contestParts = contest.split('_');
            let contestType = contestParts[0];
            
            // Handle different contest type formats
            if (contestType === 'us') {
                contestType = 'us_senate';
            } else if (contestType === 'attorney') {
                contestType = 'attorney_general';
            } else if (contestType === 'lt') {
                contestType = 'lt_governor';
            } else if (contestType === 'commissioner') {
                // For commissioner races, include the department
                contestType = contestParts[0] + '_' + contestParts[1];
            } else if (contestType === 'state') {
                // For state auditor races
                contestType = 'state_auditor';
            }
            
            console.log('Contest type:', contestType, 'from value:', contest);
            
            updateStatus(`🔍 Loading ${contestType} ${year}...`);
            
            // Debug: Check what data structure exists
            console.log('Available years:', Object.keys(electionData.results_by_year || {}));
            if (electionData.results_by_year[year]) {
                console.log(`Available contests for ${year}:`, Object.keys(electionData.results_by_year[year]));
            }
            
            if (!electionData.results_by_year[year]) {
                updateStatus(`❌ No data for year ${year}`);
                return;
            }
            
            if (!electionData.results_by_year[year][contestType]) {
                updateStatus(`❌ No ${contestType} data for ${year}`);
                return;
            }
            
            const contestGroup = electionData.results_by_year[year][contestType];
            const contestKey = Object.keys(contestGroup)[0];
            const contestData = contestGroup[contestKey];
            
            if (!contestData.results) {
                updateStatus(`❌ No results found for ${contestKey}`);
                return;
            }
            
            const results = contestData.results;
            currentElectionResults = results;
            const precinctCount = Object.keys(results).length;
            updateStatus(`📊 Processing ${precinctCount} precincts for ${contestType} ${year}...`);
            
            // Calculate and display statewide results
            updateStatewideResults(results, contestType, year);
            
            // Track contest view
            analyticsManager.trackEvent('visualization', 'view_contest', `${contestType}_${year}`);
            console.log(`Found ${precinctCount} precincts for ${contestType} ${year}`);
            
            if (currentMode === 'county') {
                applyCountyCategories(results, contestType, year);
            } else {
                applyPrecinctCategories(results, contestType, year);
            }
            
            // After updating categories, auto-update county details if a county was previously selected
            if (lastSelectedCounty) {
                showCountyDetails(lastSelectedCounty);
            }
        }
        
        // Make applyCategories globally accessible
        window.applyCategories = applyCategories;
        
        function applyCountyCategories(results, contestType, year) {
            console.log(`Applying county categories for ${contestType} in ${year}`);
            // Aggregate by county
            const countyData = {};
            let categoryCount = {};
            
            Object.values(results).forEach(result => {
                const county = result.county;
                if (!countyData[county]) {
                    countyData[county] = { 
                        colors: [], 
                        totalVotes: 0, 
                        demTotal: 0, 
                        repTotal: 0,
                        precinctCount: 0,
                        categories: {}
                    };
                }
                
                countyData[county].totalVotes += result.total_votes;
                countyData[county].demTotal += result.dem_votes;
                countyData[county].repTotal += result.rep_votes;
                countyData[county].precinctCount++;
                
                if (result.competitiveness && result.competitiveness.color) {
                    countyData[county].colors.push(result.competitiveness.color);
                    const cat = result.competitiveness.code;
                    countyData[county].categories[cat] = (countyData[county].categories[cat] || 0) + 1;
                    categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                }
            });
            
            // Function to calculate county-level competitiveness
            function getCountyCompetitiveness(demVotes, repVotes) {
                const totalTwoParty = demVotes + repVotes;
                if (totalTwoParty === 0) return { color: '#e0e0e0', category: 'No Data', code: 'NO_DATA' };
                
                const margin = Math.abs(repVotes - demVotes) / totalTwoParty * 100;
                const winner = repVotes > demVotes ? 'REP' : 'DEM';
                
                let category, code, color;
                
                if (margin >= 40) {
                    category = winner === 'REP' ? 'Republican Annihilation' : 'Democratic Annihilation';
                    code = winner === 'REP' ? 'R_ANNIHILATION' : 'D_ANNIHILATION';
                    color = winner === 'REP' ? '#67000d' : '#08306b';  // Darkest
                } else if (margin >= 30) {
                    category = winner === 'REP' ? 'Republican Dominant' : 'Democratic Dominant';
                    code = winner === 'REP' ? 'R_DOMINANT' : 'D_DOMINANT';
                    color = winner === 'REP' ? '#a50f15' : '#08519c';  // Very dark
                } else if (margin >= 20) {
                    category = winner === 'REP' ? 'Republican Stronghold' : 'Democratic Stronghold';
                    code = winner === 'REP' ? 'R_STRONGHOLD' : 'D_STRONGHOLD';
                    color = winner === 'REP' ? '#cb181d' : '#3182bd';  // Dark
                } else if (margin >= 10) {
                    category = winner === 'REP' ? 'Republican Safe' : 'Democratic Safe';
                    code = winner === 'REP' ? 'R_SAFE' : 'D_SAFE';
                    color = winner === 'REP' ? '#ef3b2c' : '#6baed6';
                } else if (margin >= 5.5) {
                    category = winner === 'REP' ? 'Republican Likely' : 'Democratic Likely';
                    code = winner === 'REP' ? 'R_LIKELY' : 'D_LIKELY';
                    color = winner === 'REP' ? '#fb6a4a' : '#9ecae1';
                } else if (margin >= 1) {
                    category = winner === 'REP' ? 'Republican Lean' : 'Democratic Lean';
                    code = winner === 'REP' ? 'R_LEAN' : 'D_LEAN';
                    color = winner === 'REP' ? '#fcae91' : '#c6dbef';
                } else if (margin >= 0.5) {
                    category = winner === 'REP' ? 'Republican Tilt' : 'Democratic Tilt';
                    code = winner === 'REP' ? 'R_TILT' : 'D_TILT';
                    color = winner === 'REP' ? '#fee8c8' : '#e1f5fe';
                } else {
                    category = 'Tossup';
                    code = 'TOSSUP';
                    color = '#f7f7f7';
                }
                
                return { color, category, code, margin: margin.toFixed(1), winner };
            }
            
            // Create color expression for counties
            const colorExpression = ['case'];
            let coloredCount = 0;
            let countyLevelCount = 0;
            
            Object.entries(countyData).forEach(([county, data]) => {
                const mappedName = countyNameMap[county.toUpperCase()];
                if (mappedName && (data.demTotal + data.repTotal) > 0) {
                    let finalColor;
                    
                    if (currentMode === 'county') {
                        // Use county-level competitiveness (FIXED)
                        const countyComp = getCountyCompetitiveness(data.demTotal, data.repTotal);
                        finalColor = countyComp.color;
                        countyLevelCount++;
                    } else {
                        // Use dominant precinct category (original method)
                        if (data.colors.length > 0) {
                            const colorCounts = {};
                            data.colors.forEach(color => {
                                colorCounts[color] = (colorCounts[color] || 0) + 1;
                            });
                            finalColor = Object.keys(colorCounts).reduce((a, b) => 
                                colorCounts[a] > colorCounts[b] ? a : b
                            );
                        } else {
                            finalColor = '#e0e0e0';
                        }
                    }
                    
                    colorExpression.push(['==', ['get', 'County'], mappedName]);
                    colorExpression.push(finalColor);
                    coloredCount++;
                }
            });
            
            colorExpression.push('#e0e0e0'); // Default color
            
            // Apply colors to county layer
            map.setPaintProperty('county-fill', 'fill-color', colorExpression);
            map.setPaintProperty('county-fill', 'fill-opacity', 0.8);
            
            if (currentMode === 'county') {
                updateStatus(`✅ ${contest} ${year} applied! ${coloredCount} counties colored by county-level results.`);
            } else {
                updateStatus(`✅ ${contest} ${year} applied! ${coloredCount} counties colored by dominant precinct category.`);
            }
            loadingManager.completeTask();
        }
        
        function applyPrecinctCategories(results, contestType, year) {
            console.log(`Applying precinct categories for ${contestType} in ${year}`);
            if (!precinctsLoaded) {
                updateStatus('❌ Precinct data not available');
                return;
            }
            
            // Create color expression for precincts
            const colorExpression = ['case'];
            let coloredCount = 0;
            
            // Debug info for precinct data
            console.log('Precinct results count:', Object.keys(results).length);
            console.log('Sample result:', Object.values(results)[0]);
            
            Object.entries(results).forEach(([precinctId, result]) => {
                const demVotes = result.dem_votes || 0;
                const repVotes = result.rep_votes || 0;
                const totalVotes = demVotes + repVotes;
                
                if (totalVotes > 0) {
                    const demPercent = (demVotes / totalVotes) * 100;
                    const repPercent = (repVotes / totalVotes) * 100;
                    const margin = Math.abs(demPercent - repPercent);
                    const winner = repPercent > demPercent ? 'REP' : 'DEM';
                    
                    let color;
                    if (margin >= 40) {
                        color = winner === 'REP' ? '#67000d' : '#08306b';
                    } else if (margin >= 30) {
                        color = winner === 'REP' ? '#a50f15' : '#08519c';
                    } else if (margin >= 20) {
                        color = winner === 'REP' ? '#cb181d' : '#3182bd';
                    } else if (margin >= 10) {
                        color = winner === 'REP' ? '#ef3b2c' : '#6baed6';
                    } else if (margin >= 5.5) {
                        color = winner === 'REP' ? '#fb6a4a' : '#9ecae1';
                    } else if (margin >= 1) {
                        color = winner === 'REP' ? '#fcae91' : '#c6dbef';
                    } else if (margin >= 0.5) {
                        color = winner === 'REP' ? '#fee8c8' : '#e1f5fe';
                    } else {
                        color = '#f7f7f7';
                    }
                    
                    colorExpression.push(['==', ['get', 'GEOID'], precinctId]);
                    colorExpression.push(color);
                    coloredCount++;
                }
            });
            
            colorExpression.push('#e0e0e0'); // Default color
            
            // Apply colors to precinct layer
            map.setPaintProperty('precinct-fill', 'fill-color', colorExpression);
            map.setPaintProperty('precinct-fill', 'fill-opacity', 0.7);
            
            updateStatus(`✅ ${contest} ${year} applied! ${coloredCount} precincts colored by category.`);
        }
        
        function resetView() {
            map.setPaintProperty('county-fill', 'fill-color', '#e0e0e0');
            if (precinctsLoaded) {
                map.setPaintProperty('precinct-fill', 'fill-color', '#e0e0e0');
            }
            map.fitBounds([[-84.5, 33.8], [-75.5, 36.6]], { padding: 50 });
            updateStatus('🔄 View reset to default');
            analyticsManager.trackEvent('map', 'reset_view');
        }
        
        function toggleLabels() {
            const visibility = map.getLayoutProperty('county-labels', 'visibility');
            if (visibility === 'visible' || visibility === undefined) {
                map.setLayoutProperty('county-labels', 'visibility', 'none');
                updateStatus('🏷️ County labels hidden');
            } else {
                map.setLayoutProperty('county-labels', 'visibility', 'visible');
                updateStatus('🏷️ County labels shown');
            }
        }
        
        function togglePrecinctsLayer() {
            if (!precinctsLoaded) {
                updateStatus('❌ Precinct data not available');
                analyticsManager.trackEvent('error', 'precincts_unavailable');
                return;
            }
            
            const visibility = map.getLayoutProperty('precinct-fill', 'visibility');
            if (visibility === 'visible') {
                map.setLayoutProperty('precinct-fill', 'visibility', 'none');
                map.setLayoutProperty('precinct-outline', 'visibility', 'none');
                updateStatus('📍 Precincts hidden');
                analyticsManager.trackEvent('visualization', 'hide_layer', 'precincts');
            } else {
                map.setLayoutProperty('precinct-fill', 'visibility', 'visible');
                map.setLayoutProperty('precinct-outline', 'visibility', 'visible');
                updateStatus('📍 Precincts shown');
                analyticsManager.trackEvent('visualization', 'show_layer', 'precincts');
            }
        }
        
        function showSwingCounties() {
            if (!currentElectionResults) {
                updateStatus('❌ Apply categories first to analyze swing counties');
                return;
            }
            
            loadingManager.startTask();
            updateStatus('🔍 Analyzing swing counties...');
            analyticsManager.trackEvent('analysis', 'find_swing_counties');
            // Implement swing county analysis here
        }

        // Swing arrow functionality
        let swingArrows = [];
        
        function calculateSwing(currentResults, previousResults, county) {
            const currentCountyResults = Object.values(currentResults).filter(r => 
                countyNameMap[r.county.toUpperCase()] === county
            );
            
            const previousCountyResults = Object.values(previousResults).filter(r => 
                countyNameMap[r.county.toUpperCase()] === county
            );
            
            if (currentCountyResults.length === 0 || previousCountyResults.length === 0) {
                return null;
            }
            
            // Calculate current election percentages
            const currentTotal = currentCountyResults.reduce((sum, r) => sum + r.total_votes, 0);
            const currentDem = currentCountyResults.reduce((sum, r) => sum + r.dem_votes, 0);
            const currentRep = currentCountyResults.reduce((sum, r) => sum + r.rep_votes, 0);
            const currentDemPct = (currentDem / currentTotal) * 100;
            const currentRepPct = (currentRep / currentTotal) * 100;
            
            // Calculate previous election percentages
            const previousTotal = previousCountyResults.reduce((sum, r) => sum + r.total_votes, 0);
            const previousDem = previousCountyResults.reduce((sum, r) => sum + r.dem_votes, 0);
            const previousRep = previousCountyResults.reduce((sum, r) => sum + r.rep_votes, 0);
            const previousDemPct = (previousDem / previousTotal) * 100;
            const previousRepPct = (previousRep / previousTotal) * 100;
            
            // Calculate margin swing
            const currentMargin = currentRepPct - currentDemPct;
            const previousMargin = previousRepPct - previousDemPct;
            const swing = currentMargin - previousMargin;
            
            return {
                swing: swing,
                magnitude: Math.abs(swing)
            };
        }

        function showSwingArrows() {
            const compareValue = document.getElementById('compare-election').value;
            if (!compareValue || !currentElectionResults) {
                updateStatus('❌ Please select both a current and comparison election');
                analyticsManager.trackEvent('error', 'swing_comparison_missing_data');
                return;
            }
            loadingManager.startTask();

            hideSwingArrows(); // Clear existing arrows
            
            // Get previous election results
            const contestParts = compareValue.split('_');
            const year = compareValue.match(/_(\d{4})_/)[1];
            
            // Handle different naming conventions for contest types
            let effectiveContestType = contestParts[0];
            
            // Map contest types to their full names
            if (effectiveContestType === 'us') {
                effectiveContestType = 'us_senate';
            } else if (effectiveContestType === 'attorney') {
                effectiveContestType = 'attorney_general';
            } else if (effectiveContestType === 'lt') {
                effectiveContestType = 'lt_governor';
            } else if (effectiveContestType === 'commissioner') {
                // For commissioner races, include the department
                effectiveContestType = contestParts[0] + '_' + contestParts[1];
            }
            
            console.log('Loading previous results:', {year, effectiveContestType, compareValue});
            console.log('Available contests:', Object.keys(electionData.results_by_year[year] || {}));
            
            if (!electionData.results_by_year[year] || !electionData.results_by_year[year][effectiveContestType]) {
                updateStatus('❌ No data available for ' + effectiveContestType + ' ' + year);
                return;
            }
            
            const contestData = electionData.results_by_year[year][effectiveContestType][compareValue];
            if (!contestData || !contestData.results) {
                updateStatus('❌ No results found for ' + compareValue);
                return;
            }
            
            const previousResults = contestData.results;
            
            // Get all counties from the map source
            const counties = map.getSource('counties')._data.features;
            
            counties.forEach(county => {
                const countyName = county.properties.County;
                const swingData = calculateSwing(currentElectionResults, previousResults, countyName);
                
                if (swingData && Math.abs(swingData.swing) >= 0.5) { // Only show arrows for swings >= 0.5%
                    // Get county centroid
                    const coordinates = turf.centroid(county.geometry).geometry.coordinates;
                    const point = map.project(coordinates);
                    
                    // Create arrow element
                    const arrow = document.createElement('div');
                    arrow.className = 'swing-arrow ' + (swingData.swing > 0 ? 'republican' : 'democratic');
                    
                    // Scale arrow size based on swing magnitude (min 1x, max 3x)
                    const scale = Math.min(3, 1 + (Math.abs(swingData.swing) / 10));
                    const rotate = swingData.swing > 0 ? 0 : 180; // Right for Republican swing, Left for Democratic swing
                    arrow.style.transform = 'translate(-50%, -50%) rotate(' + rotate + 'deg) scale(' + scale + ')';
                    
                    // Position the arrow at county center
                    arrow.style.left = point.x + 'px';
                    arrow.style.top = point.y + 'px';
                    
                    // Add tooltip
                    arrow.title = countyName + ': ' + (swingData.swing > 0 ? 'R' : 'D') + '+' + Math.abs(swingData.swing).toFixed(1) + '%';
                    
                    document.body.appendChild(arrow);
                    swingArrows.push(arrow);
                }
            });
            
            updateStatus('✅ Showing party swing arrows');
            loadingManager.completeTask();
            analyticsManager.trackEvent('visualization', 'show_swing_arrows', `${contest}_vs_${compareValue}`);
        }

        function hideSwingArrows() {
            swingArrows.forEach(arrow => {
                arrow.remove();
            });
            swingArrows = [];
            updateStatus('✅ Removed swing arrows');
            analyticsManager.trackEvent('visualization', 'hide_swing_arrows');
        }

        // Update swing arrows on map move
        map.on('move', () => {
            swingArrows.forEach(arrow => {
                arrow.remove();
            });
            if (swingArrows.length > 0) {
                showSwingArrows();
            }
        });
        
        // Unified function to show county details in sidebar
function showCountyDetails(countyName) {
    const countyDetails = document.getElementById('county-details');
    const countyNameElement = document.getElementById('county-name');
    const countyInfoContent = document.getElementById('county-info-content');
    if (!countyDetails || !countyNameElement || !countyInfoContent) {
        console.error('County sidebar elements not found');
        return;
    }
    countyNameElement.textContent = countyName + ' County';
    let sidebarContent = '';
    if (currentElectionResults) {
        const countyResults = Object.values(currentElectionResults).filter(r => countyNameMap[r.county.toUpperCase()] === countyName);
        if (countyResults.length > 0) {
            const totalVotes = countyResults.reduce((sum, r) => sum + r.total_votes, 0);
            const demVotes = countyResults.reduce((sum, r) => sum + r.dem_votes, 0);
            const repVotes = countyResults.reduce((sum, r) => sum + r.rep_votes, 0);
            const demPct = ((demVotes / totalVotes) * 100).toFixed(1);
            const repPct = ((repVotes / totalVotes) * 100).toFixed(1);
            const firstResult = countyResults[0];
            const demCandidate = firstResult.dem_candidate || 'Democratic';
            const repCandidate = firstResult.rep_candidate || 'Republican';
            const margin = repVotes - demVotes;
            const marginPct = (Math.abs(margin) / totalVotes * 100).toFixed(1);
            const winner = margin > 0 ? 'Republican' : 'Democratic';
            const winnerCandidate = margin > 0 ? repCandidate : demCandidate;
            const marginText = margin > 0 ? 'R+' + marginPct + '%' : 'D+' + marginPct + '%';
            const winnerColor = winner === 'Republican' ? '#dc2626' : '#2563eb';
            sidebarContent += '<div class="result-summary">';
            sidebarContent += '<h5>📊 Election Results</h5>';
            sidebarContent += '<p><strong>Precincts:</strong> ' + countyResults.length + '</p>';
            sidebarContent += '<p><strong>Total Votes:</strong> ' + totalVotes.toLocaleString() + '</p>';
            sidebarContent += `</div>`;
            sidebarContent += `<div class="winner-section">`;
            sidebarContent += '<h5>🏆 Winner</h5>';
            sidebarContent += '<p style="color: ' + winnerColor + '; font-weight: bold; font-size: 16px;">' + winnerCandidate + '</p>';
            sidebarContent += `</div>`;
            sidebarContent += `<div class="margin-section">`;
            sidebarContent += '<h5>📈 Margin</h5>';
            sidebarContent += '<p style="color: ' + winnerColor + '; font-weight: bold; font-size: 18px;">' + marginText + '</p>';
            sidebarContent += '<p style="color: #6b7280; font-size: 14px;">(' + Math.abs(margin).toLocaleString() + ' vote margin)</p>';
            sidebarContent += `</div>`;
            sidebarContent += `<div class="vote-breakdown">`;
            sidebarContent += '<h5>🗳️ Vote Breakdown</h5>';
            sidebarContent += '<p><span style="color: #2563eb; font-weight: bold;">' + demCandidate + ':</span> ' + demPct + '% (' + demVotes.toLocaleString() + ')</p>';
            sidebarContent += '<p><span style="color: #dc2626; font-weight: bold;">' + repCandidate + ':</span> ' + repPct + '% (' + repVotes.toLocaleString() + ')</p>';
            sidebarContent += `</div>`;
            let competitiveness;
            const actualMarginPct = parseFloat(marginPct);
            if (actualMarginPct >= 40) {
                competitiveness = winner === 'Republican' ? "Annihilation Rep" : "Annihilation Dem";
            } else if (actualMarginPct >= 30) {
                competitiveness = winner === 'Republican' ? "Dominant Rep" : "Dominant Dem";
            } else if (actualMarginPct >= 20) {
                competitiveness = winner === 'Republican' ? "Stronghold Rep" : "Stronghold Dem";
            } else if (actualMarginPct >= 10) {
                competitiveness = winner === 'Republican' ? "Safe Rep" : "Safe Dem";
            } else if (actualMarginPct >= 5.5) {
                competitiveness = winner === 'Republican' ? "Likely Rep" : "Likely Dem";
            } else if (actualMarginPct >= 1) {
                competitiveness = winner === 'Republican' ? "Lean Rep" : "Lean Dem";
            } else if (actualMarginPct >= 0.5) {
                competitiveness = winner === 'Republican' ? "Tilt Rep" : "Tilt Dem";
            } else {
                competitiveness = "Tossup";
            }
            let compColor = '#6b7280';
            if (competitiveness.includes('Rep')) {
                if (competitiveness.includes('Annihilation')) compColor = '#450a0a';
                else if (competitiveness.includes('Dominant')) compColor = '#7f1d1d';
                else if (competitiveness.includes('Stronghold')) compColor = '#991b1b';
                else if (competitiveness.includes('Safe')) compColor = '#dc2626';
                else if (competitiveness.includes('Likely')) compColor = '#ef4444';
                else if (competitiveness.includes('Lean')) compColor = '#f87171';
                else if (competitiveness.includes('Tilt')) compColor = '#fca5a5';
            } else if (competitiveness.includes('Dem')) {
                if (competitiveness.includes('Annihilation')) compColor = '#0c1d56';
                else if (competitiveness.includes('Dominant')) compColor = '#1e3a8a';
                else if (competitiveness.includes('Stronghold')) compColor = '#1e40af';
                else if (competitiveness.includes('Safe')) compColor = '#3b82f6';
                else if (competitiveness.includes('Likely')) compColor = '#60a5fa';
                else if (competitiveness.includes('Lean')) compColor = '#93c5fd';
                else if (competitiveness.includes('Tilt')) compColor = '#bfdbfe';
            }
            sidebarContent += `<div class="competitiveness-section">`;
            sidebarContent += '<h5>🎯 Competitiveness</h5>';
            sidebarContent += '<p style="color: ' + compColor + '; font-weight: bold; font-size: 16px;">' + competitiveness + '</p>';
            if (actualMarginPct <= 0.5) {
                sidebarContent += `<p style="color: #f59e0b; font-style: italic;">(Extremely close!)</p>`;
            } else if (actualMarginPct <= 1) {
                sidebarContent += `<p style="color: #f59e0b; font-style: italic;">(Very close!)</p>`;
            }
            sidebarContent += `</div>`;
        } else {
            sidebarContent += `<p><em>No detailed election data available for this county.</em></p>`;
        }
    } else {
        sidebarContent += `<p><em>No election data loaded. Please select an election from the dropdown.</em></p>`;
    }
    countyInfoContent.innerHTML = sidebarContent;
    countyDetails.style.display = 'block';
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('minimized')) {
        toggleSidebar();
    }
    const contest = document.getElementById('contest').value;
    analyticsManager.trackEvent('interaction', 'select_county', `${countyName}_${contest}`);
    updateStatus(`📍 Selected: ${countyName} County`);
}

// County click handler
map.on('click', 'county-fill', (e) => {
    const countyName = e.features[0].properties.County;
    lastSelectedCounty = countyName;
    showCountyDetails(countyName);
});

// County search bar logic (no dropdown)
const countySearch = document.getElementById('county-search');
if (countySearch) {
    countySearch.addEventListener('input', function() {
        const search = this.value.trim().toLowerCase();
        if (search.length > 0) {
            // Try to match county name
            const counties = [
                "Alamance","Alexander","Alleghany","Anson","Ashe","Avery","Beaufort","Bertie","Bladen","Brunswick","Buncombe","Burke","Cabarrus","Caldwell","Camden","Carteret","Caswell","Catawba","Chatham","Cherokee","Chowan","Clay","Cleveland","Columbus","Craven","Cumberland","Currituck","Dare","Davidson","Davie","Duplin","Durham","Edgecombe","Forsyth","Franklin","Gaston","Gates","Graham","Granville","Greene","Guilford","Halifax","Harnett","Haywood","Henderson","Hertford","Hoke","Hyde","Iredell","Jackson","Johnston","Jones","Lee","Lenoir","Lincoln","McDowell","Macon","Madison","Martin","Mecklenburg","Mitchell","Montgomery","Moore","Nash","New Hanover","Northampton","Onslow","Orange","Pamlico","Pasquotank","Pender","Perquimans","Person","Pitt","Polk","Randolph","Richmond","Robeson","Rockingham","Rowan","Rutherford","Sampson","Scotland","Stanly","Stokes","Surry","Swain","Transylvania","Tyrrell","Union","Vance","Wake","Warren","Washington","Watauga","Wayne","Wilkes","Wilson","Yadkin","Yancey"
            ];
            const match = counties.find(c => c.toLowerCase().startsWith(search));
            if (match) {
                showCountyDetails(match);
            }
        }
    });
}
    </script>
</body>
</html>
